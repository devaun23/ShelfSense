# Internal Medicine Question Generation Manifest
## 2,500 Question Distribution Strategy

**Target**: Generate 2,500 high-quality Internal Medicine questions
**Current IM Questions**: ~500 (estimated from 1,294 total across all specialties)
**Timeline**: Phased approach with quality checkpoints
**Quality Bar**: NBME-calibrated, elite validation, no vague terms/testwiseness cues

---

## 1. EXACT QUESTION DISTRIBUTION

### 1.1 Subspecialty Distribution (Total: 2,500)

Based on NBME Internal Medicine Shelf blueprint and clinical frequency:

| Subspecialty | % | Questions | Rationale |
|--------------|---|-----------|-----------|
| **Cardiology** | 13% | 325 | 10-15% on IM shelf, highest yield |
| **Pulmonology** | 10% | 250 | 8-12% on shelf, common inpatient |
| **Gastroenterology** | 10% | 250 | 8-12% on shelf, high procedural yield |
| **Infectious Disease** | 10% | 250 | 8-12% on shelf, critical reasoning |
| **Renal/Nephrology** | 8% | 200 | 6-10% on shelf, CRITICAL GAP (current: 130) |
| **Endocrinology** | 8% | 200 | 6-10% on shelf, CRITICAL GAP (current: 25) |
| **Hematology/Oncology** | 8% | 200 | 6-10% on shelf, CRITICAL GAP (current: 31) |
| **Rheumatology** | 6% | 150 | 4-8% on shelf, pattern recognition heavy |
| **Neurology** | 6% | 150 | Critical inpatient conditions, GAP (current: 94) |
| **Immunology/Allergy** | 4% | 100 | Integrated into other systems, GAP (current: 15) |
| **Ethics/Professionalism** | 10% | 250 | CRITICAL GAP (current: 0), high shelf % |
| **Biostatistics/Epidemiology** | 5% | 125 | CRITICAL GAP (current: 12), guaranteed points |
| **Multisystem/Integration** | 2% | 50 | Complex cases, pattern integration, GAP (current: 34) |

**TOTAL**: 2,500 questions

---

### 1.2 Task Type Distribution (Per NBME Competencies)

Each subspecialty must follow this task breakdown:

| Task Type | % | Per 250Q Block | Description |
|-----------|---|----------------|-------------|
| **Diagnosis** | 18% | 45 | "Most likely diagnosis?" |
| **Lab/Diagnostic Studies** | 15% | 38 | "Next diagnostic test?" CRITICAL GAP (current: 128/600) |
| **Mixed Management** | 14% | 35 | "Next best step?" CRITICAL GAP (current: 243/560) |
| **Pharmacotherapy** | 10% | 25 | "Best treatment?" CRITICAL GAP (current: 12/400) |
| **Clinical Interventions** | 8% | 20 | "Best intervention?" GAP (current: 92/320) |
| **Prognosis** | 7% | 18 | "Most likely outcome?" GAP (current: 33/280) |
| **Health Maintenance** | 7% | 18 | "Best preventive measure?" GAP (current: 45/300) |
| **Professionalism** | 6% | 15 | Ethics, communication, consent, GAP (current: 1/240) |
| **Systems Practice** | 6% | 15 | Safety, quality, systems, GAP (current: 7/240) |
| **Practice Learning** | 4% | 10 | Evidence-based medicine, GAP (current: 28/160) |
| **Mechanism** | 5% | 13 | "Most likely mechanism?" (pathophysiology) |

**Example for Cardiology (325 questions)**:
- Diagnosis: 59 questions
- Lab/Diagnostic: 49 questions
- Mixed Management: 46 questions
- Pharmacotherapy: 33 questions
- Clinical Interventions: 26 questions
- Prognosis: 23 questions
- Health Maintenance: 23 questions
- Professionalism: 20 questions
- Systems Practice: 20 questions
- Practice Learning: 13 questions
- Mechanism: 16 questions

---

### 1.3 Difficulty Distribution (Per IRT Calibration)

Target shelf exam performance: 60-70% accuracy

| Difficulty | % | Per 100Q | Target Accuracy | IRT Difficulty |
|------------|---|----------|-----------------|----------------|
| **Easy** | 20% | 50 | 80-90% correct | -1.5 to -0.5 SD |
| **Medium** | 50% | 125 | 60-70% correct | -0.5 to +0.5 SD |
| **Hard** | 25% | 63 | 40-50% correct | +0.5 to +1.5 SD |
| **Very Hard** | 5% | 12 | 20-30% correct | +1.5 to +2.5 SD |

**Rationale**:
- **Easy**: Build confidence, test core knowledge (e.g., classic MI presentation)
- **Medium**: NBME standard difficulty, clinical reasoning
- **Hard**: Atypical presentations, rare complications, multi-step reasoning
- **Very Hard**: NBME "killer" questions, integration, subtle clinical nuances

---

### 1.4 3D Matrix: Subspecialty × Task × Difficulty

**Cardiology Example (325 total)**:

| Task | Easy (20%) | Medium (50%) | Hard (25%) | Very Hard (5%) | Total |
|------|-----------|--------------|------------|---------------|-------|
| Diagnosis | 12 | 29 | 15 | 3 | 59 |
| Lab/Diagnostic | 10 | 24 | 12 | 3 | 49 |
| Mixed Mgmt | 9 | 23 | 12 | 2 | 46 |
| Pharmacotherapy | 7 | 16 | 8 | 2 | 33 |
| Clin Interventions | 5 | 13 | 7 | 1 | 26 |
| Prognosis | 5 | 12 | 5 | 1 | 23 |
| Health Maint | 5 | 12 | 5 | 1 | 23 |
| Professionalism | 4 | 10 | 5 | 1 | 20 |
| Systems Practice | 4 | 10 | 5 | 1 | 20 |
| Practice Learning | 3 | 7 | 3 | 0 | 13 |
| Mechanism | 3 | 8 | 4 | 1 | 16 |
| **TOTAL** | 67 | 164 | 81 | 16 | **328** |

*(Repeat this matrix for all 13 subspecialties)*

---

## 2. GENERATION ORDER PRIORITY

### Phase 1: Critical Gaps (First 800 Questions)
**Priority**: Fill existing curriculum gaps immediately

| Subspecialty | Questions | Rationale |
|--------------|-----------|-----------|
| **Ethics/Professionalism** | 250 | Current: 0, essential for shelf |
| **Biostatistics/Epi** | 125 | Current: 12, guaranteed points |
| **Endocrinology** | 125 | Current: 25, 175 gap |
| **Hematology/Oncology** | 125 | Current: 31, 149 gap |
| **Renal** | 100 | Current: 130, 70 gap to 200 |
| **Neurology** | 75 | Current: 94, 56 gap to 150 |

**Task Focus for Phase 1**:
1. **Pharmacotherapy** (388 gap) - 200 questions across all Phase 1 specialties
2. **Lab/Diagnostic** (472 gap) - 200 questions
3. **Mixed Management** (317 gap) - 150 questions
4. **Professionalism** (239 gap) - 150 questions
5. **Systems Practice** (233 gap) - 100 questions

---

### Phase 2: High-Yield Core (Next 900 Questions)
**Priority**: Maximize shelf exam impact

| Subspecialty | Questions | Rationale |
|--------------|-----------|-----------|
| **Cardiology** | 325 | Highest % on shelf, most tested |
| **Pulmonology** | 250 | Inpatient heavy, critical reasoning |
| **Gastroenterology** | 250 | Common procedures, high yield |
| **Infectious Disease** | 75 | Fill to 250 total |

**Task Focus for Phase 2**:
- **Diagnosis** (fill to target): 250 questions
- **Next Step Management**: 250 questions
- **Mechanism/Pathophysiology**: 150 questions
- **Clinical Interventions**: 150 questions
- **Prognosis**: 100 questions

---

### Phase 3: Completion (Final 800 Questions)
**Priority**: Complete remaining subspecialties

| Subspecialty | Questions | Rationale |
|--------------|-----------|-----------|
| **Infectious Disease** | 175 | Complete to 250 total |
| **Rheumatology** | 150 | Pattern recognition |
| **Immunology/Allergy** | 100 | Integration topics |
| **Renal** | 100 | Complete to 200 total |
| **Endocrinology** | 75 | Complete to 200 total |
| **Hematology/Oncology** | 75 | Complete to 200 total |
| **Ethics** | 75 | Complete to 250 total (already generated in Phase 1) |
| **Multisystem** | 50 | Complex integration cases |

---

## 3. HIGH-YIELD TOPIC LIST (Top 50 Must-Have)

### Cardiology (8 topics, 40 questions each)
1. **Acute Coronary Syndrome** (STEMI vs NSTEMI, troponin curves, antiplatelet)
2. **Heart Failure** (systolic vs diastolic, BNP, diuretics, GDMT)
3. **Atrial Fibrillation** (rate vs rhythm, CHADS-VASc, anticoagulation)
4. **Hypertension** (JNC guidelines, resistant HTN, secondary causes)
5. **Valvular Disease** (timing of surgery, murmur patterns)
6. **Aortic Dissection** (type A vs B, imaging, BP control)
7. **Pericarditis/Tamponade** (ECG changes, pulsus paradoxus)
8. **Infective Endocarditis** (Duke criteria, empiric antibiotics)

### Pulmonology (6 topics, 42 questions each)
1. **COPD Exacerbation** (GOLD staging, antibiotics, NIV)
2. **Asthma** (step therapy, PFTs, acute management)
3. **Pneumonia** (CAP vs HAP, CURB-65, antibiotics)
4. **Pulmonary Embolism** (Wells score, CT vs V/Q, anticoagulation)
5. **Pleural Effusion** (Light's criteria, thoracentesis)
6. **Lung Cancer** (screening, staging, paraneoplastic syndromes)

### Gastroenterology (6 topics, 42 questions each)
1. **GI Bleeding** (upper vs lower, Blatchford score, endoscopy timing)
2. **Inflammatory Bowel Disease** (UC vs Crohn, biologics, complications)
3. **Cirrhosis Complications** (ascites, SBP, encephalopathy, varices)
4. **Acute Pancreatitis** (Ranson criteria, imaging, complications)
5. **Cholecystitis** (RUQ ultrasound, HIDA scan, antibiotics)
6. **Colorectal Cancer Screening** (colonoscopy intervals, polyp types)

### Infectious Disease (6 topics, 42 questions each)
1. **HIV/AIDS** (opportunistic infections, CD4 thresholds, ART)
2. **Sepsis** (SIRS vs qSOFA, early antibiotics, source control)
3. **Meningitis** (empiric antibiotics by age, CSF patterns)
4. **Endocarditis** (Duke criteria, vegetation size, surgery indications)
5. **Skin/Soft Tissue Infections** (cellulitis vs necrotizing fasciitis, MRSA)
6. **Tuberculosis** (latent vs active, IGRA vs PPD, treatment)

### Renal (5 topics, 40 questions each)
1. **Acute Kidney Injury** (prerenal vs intrinsic vs postrenal, FeNa)
2. **Chronic Kidney Disease** (staging, anemia management, dialysis timing)
3. **Electrolyte Disorders** (hyponatremia, hyperkalemia, hypercalcemia)
4. **Acid-Base Disorders** (anion gap, Winter's formula, compensation)
5. **Nephrotic vs Nephritic Syndrome** (proteinuria, hematuria, causes)

### Endocrinology (5 topics, 40 questions each)
1. **Diabetes Mellitus** (type 1 vs 2, HbA1c targets, complications)
2. **Diabetic Ketoacidosis/HHS** (anion gap, insulin protocol, complications)
3. **Thyroid Disorders** (hypo/hyperthyroidism, nodules, thyroid storm)
4. **Adrenal Disorders** (Addison's, Cushing's, pheochromocytoma)
5. **Hypoglycemia** (whipple triad, insulinoma, factitious)

### Hematology/Oncology (5 topics, 40 questions each)
1. **Anemia Workup** (microcytic, normocytic, macrocytic, reticulocyte count)
2. **Transfusion Medicine** (reactions, thresholds, massive transfusion)
3. **Anticoagulation** (warfarin, DOACs, heparin, reversal agents)
4. **Thrombocytopenia** (ITP, TTP, HIT, DIC)
5. **Venous Thromboembolism** (prophylaxis, treatment, duration)

### Rheumatology (4 topics, 38 questions each)
1. **Rheumatoid Arthritis** (diagnosis, DMARDs, biologics)
2. **Systemic Lupus Erythematosus** (criteria, complications, treatment)
3. **Gout/Pseudogout** (joint aspiration, uric acid, treatment)
4. **Giant Cell Arteritis/PMR** (temporal artery biopsy, steroids)

### Ethics/Professionalism (5 topics, 50 questions each)
1. **Informed Consent** (capacity, surrogate decision-making, advance directives)
2. **Confidentiality** (HIPAA, breaking confidentiality, minor consent)
3. **End-of-Life Care** (DNR/DNI, palliative care, hospice criteria)
4. **Difficult Conversations** (breaking bad news, addressing anger)
5. **Professional Boundaries** (gifts, social media, dual relationships)

### Biostatistics/Epidemiology (3 topics, 42 questions each)
1. **Study Design** (RCT vs cohort vs case-control, bias types)
2. **Diagnostic Statistics** (sensitivity, specificity, PPV, NPV, likelihood ratios)
3. **Clinical Significance** (p-value, confidence intervals, NNT, relative risk)

### Neurology (4 topics, 38 questions each)
1. **Stroke** (ischemic vs hemorrhagic, tPA criteria, imaging)
2. **Seizures** (status epilepticus, anticonvulsants, first seizure workup)
3. **Headache** (migraine vs cluster vs temporal arteritis, red flags)
4. **Dementia** (Alzheimer vs vascular vs Lewy body, workup)

---

## 4. QUALITY CHECKPOINTS

### Checkpoint Frequency
- **Every 50 questions**: Automated validation check
- **Every 250 questions**: Manual expert review batch
- **Every 500 questions**: Comprehensive quality audit + gap reanalysis

### Validation Gates (Must Pass Before Proceeding)

#### Gate 1: Automated Validation (Every Question)
**Run**: `question_validators.py` on every generated question

**Requirements**:
- ✓ No vague clinical terms (explicit BP, HR, lab values)
- ✓ No testwiseness cues (length, specificity, absolute terms)
- ✓ 5 distinct, homogeneous distractors
- ✓ Answer key in A-E
- ✓ Explanation has all 5 choice rationales
- ✓ Arrow notation (→) in clinical reasoning
- ✓ Medical units without spaces (mg/dL, mmHg, etc.)

**Rejection Threshold**: <90% pass rate → pause generation, review prompts

---

#### Gate 2: Elite Quality Validation (Every 250 Questions)
**Run**: `elite_quality_validator.py` batch analysis

**Requirements**:
1. **NBME Pattern Matching**:
   - Lead-in follows "cover the options" rule
   - Vignette follows age-gender-setting-complaint template
   - Single best answer (no "all of the above")

2. **Distractor Quality**:
   - Each distractor represents plausible reasoning error
   - No "do nothing" in acute settings
   - Homogeneous (all diagnoses OR all treatments)

3. **Clinical Accuracy**:
   - Current evidence-based guidelines
   - Realistic lab values/vital signs
   - Appropriate for clinical setting

4. **Explanation Quality**:
   - Educational objective clear
   - Pathophysiology explained
   - Differential comparison included
   - 3+ clinical pearls
   - Mnemonic/analogy when applicable

**Acceptance Rate**: ≥85% of batch must pass all criteria
**Action if Failed**: Regenerate failed questions, adjust prompts

---

#### Gate 3: Comprehensive Audit (Every 500 Questions)
**Manual Review by Medical Educator**

**Sample Size**: 50 random questions (10% of batch)

**Audit Criteria**:
1. **Medical Accuracy**: 100% factually correct
2. **NBME Fidelity**: Indistinguishable from real shelf questions
3. **Difficulty Calibration**: Matches intended easy/medium/hard
4. **Learning Value**: Students learn from both correct and incorrect answers
5. **No Patterns**: No detectable AI fingerprints (e.g., always using specific phrases)

**Benchmark**: ≥90% of sample rated "shelf-quality" or better

**Action if Failed**:
- Identify systemic issues (e.g., all cardio questions too easy)
- Adjust generation parameters
- Regenerate weak subcategory

---

### Batch Size Strategy
**Optimal Batch**: 50 questions per generation run

**Rationale**:
- Large enough for efficiency
- Small enough to catch quality drift early
- Allows prompt tuning between batches
- Matches checkpoint frequency (every 50)

---

## 5. GAP FILLING STRATEGY

### 5.1 Using curriculum_gaps.json

**Current Gaps** (from curriculum_gaps.json):

| System/Task | Current | Target | Gap | Priority |
|-------------|---------|--------|-----|----------|
| social_sciences_ethics | 0 | 500 | 500 | HIGH |
| renal_urinary_reproductive | 130 | 400 | 270 | HIGH |
| musculoskeletal_skin | 148 | 360 | 212 | HIGH |
| behavioral_health | 46 | 300 | 254 | MEDIUM |
| lab_diagnostic (task) | 128 | 600 | 472 | HIGH |
| pharmacotherapy (task) | 12 | 400 | 388 | MEDIUM |
| mixed_management (task) | 243 | 560 | 317 | HIGH |

**Integration Strategy**:

1. **Before Each Phase**: Re-run gap analysis
   ```bash
   python scripts/analyze_curriculum_gaps.py --specialty internal_medicine
   ```

2. **Dynamic Adjustment**: If generation creates new imbalances:
   - Pause current phase
   - Generate 50-100 questions in underrepresented area
   - Resume main phase

3. **Task-First vs Specialty-First**:
   - **Phase 1**: Task-first (fill pharmacotherapy, lab_diagnostic gaps across all specialties)
   - **Phase 2**: Specialty-first (complete cardiology, pulmonology top to bottom)
   - **Phase 3**: Balanced (interleave tasks and specialties to fill final gaps)

---

### 5.2 Regenerating Gap Analysis

**Frequency**: After every 500 questions generated

**Command**:
```bash
# Full gap analysis
python scripts/analyze_curriculum_gaps.py \
  --specialty internal_medicine \
  --output backend/im_gaps_$(date +%Y%m%d).json

# Compare to baseline
python scripts/compare_gap_progress.py \
  --baseline backend/curriculum_gaps.json \
  --current backend/im_gaps_$(date +%Y%m%d).json
```

**Action Thresholds**:
- **New gap >100 questions**: Immediate correction batch
- **Task imbalance >15% deviation**: Adjust next phase distribution
- **Difficulty drift**: Regenerate with explicit difficulty targeting

---

## 6. GENERATION CONFIGURATION

### 6.1 Prompt Engineering

**Base Prompt Template** (already in `question_generator.py`):
```python
specialty = "Internal Medicine - {subspecialty}"
topic = {high_yield_topic}
question_type = {task_type}  # diagnosis, next_step, etc.
difficulty = {difficulty_level}  # easy, medium, hard, very_hard
```

**Difficulty-Specific Modifications**:

**Easy** (target 80-90% accuracy):
```
- Classic presentation with pathognomonic findings
- No atypical features or red herrings
- Distractors are clearly wrong to informed student
- Single-step reasoning
Example: "57F with sudden chest pain, ST elevations V2-V4, troponin 8.5"
```

**Medium** (target 60-70% accuracy):
```
- Typical presentation but requires clinical reasoning
- Some atypical features or competing diagnoses
- Distractors are plausible but ultimately incorrect
- Two-step reasoning (recognize → act)
Example: "68M with dyspnea, JVP 12cm, CXR shows bilateral pleural effusions, BNP 850"
```

**Hard** (target 40-50% accuracy):
```
- Atypical presentation or rare complication
- Multiple plausible diagnoses/treatments
- Distractors represent common reasoning errors
- Three-step reasoning with integration
Example: "45F with HTN on lisinopril, K+ 6.2, peaked T waves, but asymptomatic"
```

**Very Hard** (target 20-30% accuracy):
```
- Rare presentation or "zebra" diagnosis
- Requires synthesis of multiple domains
- Distractors are nearly correct (e.g., correct category, wrong timing)
- NBME "killer question" characteristics
Example: "32M with fever, new murmur, negative blood cultures, recent dental work, echo shows small vegetation - what organism?"
```

---

### 6.2 API Configuration

**OpenAI Settings**:
```python
model = "gpt-4o"  # Current best for medical accuracy
temperature = 0.7  # Balanced creativity + consistency
max_tokens = 2500  # For comprehensive explanations
response_format = {"type": "json_object"}
```

**Rate Limiting** (from `rate_limiter.py`):
- Per-minute burst limit: 20 questions/min
- Daily limit (free tier): 10 AI questions
- Daily limit (premium): unlimited
- Circuit breaker: 5 failures → 120s cooldown

**Optimization**:
- Use caching for repeated topics (7-day TTL)
- Batch generation in off-peak hours
- Monitor circuit breaker metrics

---

### 6.3 Database Schema

**New Fields Required**:
```python
Question.subspecialty = Column(String)  # "Cardiology", "Pulmonology", etc.
Question.task_type = Column(String)  # "diagnosis", "next_step", etc.
Question.difficulty_target = Column(String)  # "easy", "medium", "hard", "very_hard"
Question.generation_batch = Column(String)  # "IM_Phase1_Batch5"
Question.validation_passed = Column(Boolean)  # Passed all validators
Question.expert_reviewed = Column(Boolean)  # Manual review complete
```

---

## 7. SUCCESS METRICS

### Phase Completion Criteria

**Phase 1 Complete** (800 questions):
- ✓ All HIGH priority gaps <50 questions
- ✓ Ethics/professionalism: 250 questions generated
- ✓ Pharmacotherapy: +200 questions (from 12 → 212)
- ✓ Lab/diagnostic: +200 questions (from 128 → 328)
- ✓ 85%+ validation pass rate
- ✓ Manual audit: 90%+ shelf-quality

**Phase 2 Complete** (900 questions):
- ✓ Cardiology: 325 questions across all tasks/difficulties
- ✓ Pulmonology: 250 questions
- ✓ Gastroenterology: 250 questions
- ✓ Infectious Disease: 250 total (including Phase 1)
- ✓ No subspecialty <80% of target distribution
- ✓ All task types within ±10% of target %

**Phase 3 Complete** (800 questions):
- ✓ All 13 subspecialties at 100% target
- ✓ All task types at 100% target
- ✓ Difficulty distribution: 20/50/25/5 achieved
- ✓ Final gap analysis: all gaps <10 questions
- ✓ Expert review: 95%+ approval rate

---

### Quality Metrics Dashboard

**Track Daily**:
- Questions generated (cumulative)
- Validation pass rate (%)
- Subspecialty distribution (current vs target)
- Task type distribution (current vs target)
- Difficulty distribution (current vs target)
- Cache hit rate (%)
- Circuit breaker status

**Track Weekly**:
- Expert review approval rate (%)
- Student accuracy on new questions (from alpha testing)
- Question uniqueness score (anti-plagiarism check)
- Explanation quality score (1-100)

---

## 8. IMPLEMENTATION TIMELINE

### Week 1-2: Phase 1 Setup + Gap Filling (800 Questions)
**Days 1-3**: Infrastructure
- Configure batch generation pipeline
- Set up validation gates
- Create monitoring dashboard

**Days 4-7**: Ethics/Professionalism (250 Q)
- 50Q/day generation rate
- Focus on consent, confidentiality, end-of-life

**Days 8-10**: Biostatistics/Epi (125 Q)
- 42Q/day generation rate
- Study design, diagnostic stats, clinical significance

**Days 11-14**: Endocrinology/Hematology/Renal (350 Q)
- Fill critical system gaps
- Heavy pharmacotherapy/lab diagnostic focus

**Checkpoint**: Gap reanalysis, quality audit

---

### Week 3-4: Phase 2 High-Yield Core (900 Questions)
**Days 15-18**: Cardiology (325 Q)
- 81Q/day generation rate
- ACS, HF, AFib, valvular, HTN

**Days 19-21**: Pulmonology (250 Q)
- 83Q/day generation rate
- COPD, asthma, pneumonia, PE

**Days 22-24**: Gastroenterology (250 Q)
- 83Q/day generation rate
- GI bleed, IBD, cirrhosis, pancreatitis

**Days 25-28**: Infectious Disease Completion (75 Q)
- Complete to 250 total
- HIV, sepsis, meningitis, endocarditis

**Checkpoint**: Quality audit, difficulty calibration check

---

### Week 5-6: Phase 3 Completion (800 Questions)
**Days 29-32**: Rheumatology, Immunology, Neurology (400 Q)
- 100Q/day generation rate
- Pattern-heavy subspecialties

**Days 33-35**: Multisystem Integration (50 Q)
- 17Q/day generation rate
- Complex cases requiring cross-specialty reasoning

**Days 36-38**: Gap Filling (350 Q)
- Dynamic allocation based on final gap analysis
- Focus on underrepresented task types

**Days 39-42**: Final Quality Pass
- Manual review of 250 random questions (10% sample)
- Regenerate any failures
- Final database validation

---

## 9. RISK MITIGATION

### Risk 1: OpenAI Rate Limits Hit
**Mitigation**:
- Reduce generation rate to 30Q/day
- Use extended timeline (8 weeks instead of 6)
- Increase cache TTL to reduce API calls
- Consider GPT-4 Turbo for faster generation

### Risk 2: Quality Drift (Pass Rate Drops Below 85%)
**Mitigation**:
- Immediate halt of generation
- Manual review of last 50 questions
- Identify prompt issues (e.g., vague terms creeping in)
- Adjust prompt engineering
- Regenerate failed batch

### Risk 3: Circuit Breaker Opens Frequently
**Mitigation**:
- Implement exponential backoff (already in `openai_service.py`)
- Reduce concurrent requests
- Schedule generation during off-peak hours (2am-6am EST)
- Monitor Sentry for API error patterns

### Risk 4: Expert Reviewer Bandwidth
**Mitigation**:
- Recruit 2-3 medical educators for review rotation
- Provide review interface in admin dashboard
- Compensate reviewers ($50/250 questions reviewed)
- Prioritize high-stakes questions (very hard, ethics)

### Risk 5: Subspecialty Imbalance Persists
**Mitigation**:
- Weekly gap analysis (not just every 500Q)
- Dynamic reallocation of remaining budget
- Pause low-priority specialties if gaps widen
- Backfill strategy in Phase 3

---

## 10. POST-GENERATION VALIDATION

### Step 1: Database Integrity Check
```sql
-- Verify subspecialty distribution
SELECT subspecialty, COUNT(*) as count
FROM questions
WHERE specialty = 'internal_medicine'
  AND source LIKE '%AI Generated%'
GROUP BY subspecialty
ORDER BY count DESC;

-- Verify task type distribution
SELECT task_type, COUNT(*) as count
FROM questions
WHERE specialty = 'internal_medicine'
GROUP BY task_type
ORDER BY count DESC;

-- Verify difficulty distribution
SELECT difficulty_level, COUNT(*) as count
FROM questions
WHERE specialty = 'internal_medicine'
GROUP BY difficulty_level
ORDER BY count DESC;
```

### Step 2: Uniqueness Check
```python
# Check for duplicate vignettes (plagiarism detection)
from difflib import SequenceMatcher

all_vignettes = db.query(Question.vignette).all()
for i, v1 in enumerate(all_vignettes):
    for v2 in all_vignettes[i+1:]:
        similarity = SequenceMatcher(None, v1, v2).ratio()
        if similarity > 0.85:
            print(f"DUPLICATE DETECTED: {similarity}")
```

### Step 3: Alpha Testing
- Select 100 random questions
- Assign to 10 medical students
- Track accuracy, time spent, confidence
- Collect feedback on quality
- Target: 60-70% average accuracy

### Step 4: IRT Calibration
- After 500+ student attempts per question
- Run IRT analysis (item_response_theory.py)
- Reclassify difficulty based on actual data
- Flag questions with poor discrimination (<0.2)

---

## APPENDIX: COMMAND REFERENCE

### Generate Single Question
```bash
curl -X POST http://localhost:8000/api/questions/generate \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "specialty": "Internal Medicine - Cardiology",
    "topic": "Acute Coronary Syndrome",
    "task_type": "diagnosis",
    "difficulty": "medium"
  }'
```

### Generate Batch
```bash
python scripts/batch_generate.py \
  --specialty "Internal Medicine - Cardiology" \
  --count 50 \
  --difficulty medium \
  --validate \
  --output cardiology_batch_001.json
```

### Run Validators
```bash
python -m app.services.question_validators \
  --input cardiology_batch_001.json \
  --output validation_report.json
```

### Gap Analysis
```bash
python scripts/analyze_curriculum_gaps.py \
  --specialty internal_medicine \
  --output im_gaps_current.json
```

### Quality Audit
```bash
python scripts/quality_audit.py \
  --batch cardiology_batch_001.json \
  --sample-size 10 \
  --reviewer drsmith
```

---

## SUMMARY

**Total Questions**: 2,500
**Timeline**: 6 weeks (42 days)
**Daily Target**: 60 questions/day
**Quality Gates**: 3 levels (automated, batch, comprehensive)
**Acceptance Threshold**: 85% validation pass, 90% expert approval

**Critical Success Factors**:
1. Phased approach (gaps first, then high-yield, then completion)
2. Continuous gap monitoring and dynamic adjustment
3. Strict validation at multiple checkpoints
4. Task-type balance maintained throughout
5. Difficulty calibration verified with student data

**End State**: 2,500 elite-quality IM questions covering all subspecialties, task types, and difficulty levels with NBME-calibrated accuracy.
