# ShelfSense Deployment Guide

Complete guide for deploying ShelfSense to production using Vercel (frontend) and Railway (backend).

## Table of Contents

1. [Prerequisites](#prerequisites)
2. [Backend Deployment (Railway)](#backend-deployment-railway)
3. [Frontend Deployment (Vercel)](#frontend-deployment-vercel)
4. [Database Setup](#database-setup)
5. [Environment Variables](#environment-variables)
6. [Post-Deployment Steps](#post-deployment-steps)
7. [Monitoring & Maintenance](#monitoring--maintenance)
8. [Troubleshooting](#troubleshooting)

---

## Prerequisites

Before deploying, ensure you have:

- [ ] GitHub account with ShelfSense repository
- [ ] Vercel account (free tier works)
- [ ] Railway account (free tier works)
- [ ] Clerk account with application configured
- [ ] OpenAI API key

---

## Backend Deployment (Railway)

### Step 1: Create Railway Project

1. Go to [Railway.app](https://railway.app) and sign in
2. Click "New Project" → "Deploy from GitHub repo"
3. Select your ShelfSense repository
4. Railway will auto-detect the Python backend

### Step 2: Configure Environment Variables

In Railway dashboard, add these environment variables:

```bash
# Database (Railway provides this automatically)
DATABASE_URL=postgresql://...  # Auto-generated by Railway

# OpenAI API
OPENAI_API_KEY=sk-...  # From https://platform.openai.com/api-keys

# Clerk Webhook
CLERK_WEBHOOK_SECRET=whsec_...  # From Clerk Dashboard

# CORS Configuration
FRONTEND_URL=https://your-app.vercel.app  # Update after frontend deployment
```

### Step 3: Configure Build Settings

Railway should auto-detect settings from `railway.toml`, but verify:

- **Build Command**: `pip install -r requirements.txt`
- **Start Command**: `uvicorn app.main:app --host 0.0.0.0 --port $PORT`
- **Health Check Path**: `/health`
- **Python Version**: 3.11

### Step 4: Deploy

1. Click "Deploy" in Railway dashboard
2. Wait for build to complete (~2-3 minutes)
3. Copy your Railway backend URL (e.g., `https://shelfsense-production.up.railway.app`)

### Step 5: Run Database Migrations

After first deployment, run migrations via Railway CLI or shell:

```bash
# In Railway dashboard, open Shell and run:
python migrate_add_clerk_id.py
python migrate_add_indexes.py
```

---

## Frontend Deployment (Vercel)

### Step 1: Create Vercel Project

1. Go to [Vercel](https://vercel.com) and sign in
2. Click "Add New Project"
3. Import your ShelfSense repository
4. Set root directory to `frontend`

### Step 2: Configure Environment Variables

In Vercel dashboard → Settings → Environment Variables:

```bash
# API URL (from Railway deployment)
NEXT_PUBLIC_API_URL=https://your-backend.up.railway.app

# Clerk Authentication
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
```

### Step 3: Configure Build Settings

Vercel should auto-detect Next.js, but verify:

- **Framework Preset**: Next.js
- **Build Command**: `npm run build`
- **Output Directory**: `.next`
- **Install Command**: `npm install`
- **Node Version**: 18.x or higher

### Step 4: Deploy

1. Click "Deploy"
2. Wait for build (~2-3 minutes)
3. Your app will be live at `https://your-app.vercel.app`

---

## Database Setup

### Development (SQLite)

For local development, SQLite is used automatically:

```bash
cd backend
python migrate_add_clerk_id.py
python migrate_add_indexes.py
```

### Production (PostgreSQL on Railway)

Railway automatically provisions PostgreSQL:

1. In Railway dashboard, your project will have both:
   - **Backend service** (Python)
   - **PostgreSQL database** (auto-provisioned)

2. Railway automatically sets `DATABASE_URL` environment variable

3. Run migrations using Railway Shell (see Backend Step 5)

---

## Environment Variables

### Backend (.env)

Copy `backend/.env.example` to `backend/.env`:

```bash
cd backend
cp .env.example .env
# Edit .env with your values
```

Required variables:
- `DATABASE_URL`: Database connection string
- `OPENAI_API_KEY`: OpenAI API key
- `CLERK_WEBHOOK_SECRET`: Clerk webhook secret
- `FRONTEND_URL`: Your Vercel frontend URL

### Frontend (.env.local)

Copy `frontend/.env.example` to `frontend/.env.local`:

```bash
cd frontend
cp .env.example .env.local
# Edit .env.local with your values
```

Required variables:
- `NEXT_PUBLIC_API_URL`: Your Railway backend URL
- `NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY`: Clerk publishable key
- `CLERK_SECRET_KEY`: Clerk secret key

---

## Post-Deployment Steps

### 1. Update Clerk Webhook

Configure Clerk webhook to sync users:

1. Go to [Clerk Dashboard](https://dashboard.clerk.com)
2. Select your application
3. Go to "Webhooks" → "Add Endpoint"
4. Set endpoint URL: `https://your-backend.up.railway.app/api/webhook/clerk`
5. Subscribe to events:
   - `user.created`
   - `user.updated`
   - `user.deleted`
6. Copy webhook secret to Railway environment variables as `CLERK_WEBHOOK_SECRET`

### 2. Update CORS Settings

Ensure backend allows your frontend domain:

In `backend/app/main.py`, verify CORS configuration includes your Vercel domain:

```python
allow_origins=[
    "http://localhost:3000",
    "https://your-app.vercel.app",  # Add your production domain
    "https://*.vercel.app",  # Allow preview deployments
]
```

### 3. Test Authentication Flow

1. Visit your Vercel frontend
2. Click "Sign Up" and create a test account
3. Verify user is created in Clerk Dashboard
4. Check Railway logs to confirm webhook received
5. Verify user appears in database

### 4. Generate Initial Questions (Optional)

If you want AI-generated questions in production:

1. Ensure `OPENAI_API_KEY` is set in Railway
2. Use the `/api/questions/generate` endpoint
3. Monitor costs in OpenAI dashboard

---

## Monitoring & Maintenance

### Performance Monitoring

Access built-in performance monitoring:

```bash
# View endpoint performance stats
GET https://your-backend.up.railway.app/debug/performance-stats

# View slow requests (>3s)
GET https://your-backend.up.railway.app/debug/slow-requests
```

### Database Health

Check database status:

```bash
# Database statistics
GET https://your-backend.up.railway.app/debug/db-stats

# Health check
GET https://your-backend.up.railway.app/health
```

### Log Monitoring

- **Railway Logs**: Railway Dashboard → Deployments → Logs
- **Vercel Logs**: Vercel Dashboard → Deployments → Functions

### Performance Targets

- AI question generation: < 3 seconds
- API endpoints: < 500ms
- Database queries: < 100ms (with indexes)
- Frontend page load: < 2 seconds

---

## Troubleshooting

### Backend Issues

**Problem**: "Database connection failed"
- **Solution**: Check `DATABASE_URL` in Railway environment variables
- Verify PostgreSQL service is running

**Problem**: "OpenAI API error"
- **Solution**: Verify `OPENAI_API_KEY` is correct
- Check OpenAI account has available credits
- Test with `/debug/test-openai` endpoint

**Problem**: "CORS error from frontend"
- **Solution**: Update CORS `allow_origins` in `main.py`
- Ensure frontend URL is correct
- Redeploy backend after changes

### Frontend Issues

**Problem**: "API requests failing"
- **Solution**: Verify `NEXT_PUBLIC_API_URL` matches Railway URL
- Check Railway backend is running
- Check CORS configuration

**Problem**: "Clerk authentication not working"
- **Solution**: Verify Clerk environment variables
- Check Clerk publishable key matches
- Ensure middleware.ts is configured correctly

**Problem**: "Build failing on Vercel"
- **Solution**: Check Node.js version (18.x required)
- Verify all dependencies in package.json
- Check build logs for specific errors

### Database Migration Issues

**Problem**: "Migration script fails"
- **Solution**: Ensure database is accessible
- Check for existing indexes (migration is idempotent)
- Run migrations manually via Railway Shell

### Performance Issues

**Problem**: "Slow API responses"
- **Solution**: Check `/debug/slow-requests` endpoint
- Verify database indexes are created
- Monitor Railway resource usage
- Consider upgrading Railway plan

**Problem**: "AI generation timeout"
- **Solution**: Implement retry logic (already in place)
- Check OpenAI API status
- Consider caching (already implemented)

---

## Deployment Checklist

Before going live:

- [ ] Backend deployed on Railway
- [ ] Frontend deployed on Vercel
- [ ] Database migrations run
- [ ] Environment variables configured
- [ ] Clerk webhook configured
- [ ] CORS settings updated
- [ ] Test user authentication flow
- [ ] Test question generation (if using AI)
- [ ] Monitor initial performance
- [ ] Check error logs
- [ ] Test all API endpoints
- [ ] Verify analytics dashboard works
- [ ] Test study modes (timed, tutor, challenge, review)
- [ ] Test spaced repetition system

---

## Continuous Deployment

Both Vercel and Railway support automatic deployments:

### Automatic Deployments

- **Push to `main` branch**: Triggers production deployment
- **Push to other branches**: Creates preview deployments

### Manual Deployments

- **Railway**: Dashboard → Deployments → "Redeploy"
- **Vercel**: Dashboard → Deployments → "Redeploy"

---

## Scaling Considerations

### When to Upgrade

Consider upgrading Railway plan when:
- Backend handles > 100 concurrent users
- Database > 1 GB
- Monthly bandwidth > 100 GB

Consider upgrading Vercel plan when:
- Frontend handles > 100k requests/month
- Team collaboration needed
- Custom domain requirements

### Cost Optimization

- Use question caching (90% cost reduction)
- Rate limit AI generation (10 questions/hour/user)
- Monitor OpenAI usage
- Use database indexes for faster queries
- Implement proper error handling to avoid retry loops

---

## Support & Resources

- **Railway Docs**: https://docs.railway.app
- **Vercel Docs**: https://vercel.com/docs
- **Clerk Docs**: https://clerk.com/docs
- **FastAPI Docs**: https://fastapi.tiangolo.com
- **Next.js Docs**: https://nextjs.org/docs

---

## Security Checklist

- [ ] All API keys stored in environment variables (never in code)
- [ ] Clerk webhook secret configured
- [ ] CORS properly configured
- [ ] Rate limiting enabled
- [ ] Database credentials secure
- [ ] HTTPS enabled on all endpoints
- [ ] Authentication required for protected routes
- [ ] Input validation on all API endpoints

---

**Last Updated**: Phase 6 - December 2024
